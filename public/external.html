<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industry Diagnostic Questionnaire</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; background-color: #f8f9fa; }
        .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        .section { margin-bottom: 30px; }
        .btn { display: inline-block; padding: 12px 24px; background: #2c3e50; color: #fff; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        .btn:hover { background: #1a252f; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .compliance-box { background: #fcfcfc; border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 25px; border-radius: 4px; font-size: 0.95em; }
        .compliance-box h3 { margin-top: 0; color: #2c3e50; font-size: 1.1em; }
        .compliance-box ul { padding-left: 20px; }
        .compliance-box li { margin-bottom: 10px; }
        .question-item { margin-bottom: 25px; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 4px; }
        .question-text { font-weight: 600; margin-bottom: 15px; display: block; }
        .likert-options { display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
        .likert-option { flex: 1; min-width: 100px; text-align: center; cursor: pointer; padding: 10px; border: 1px solid #eee; border-radius: 4px; transition: all 0.2s; }
        .likert-option:hover { background-color: #f5f5f5; }
        .likert-option input { margin-bottom: 8px; display: block; margin: 0 auto 5px; }
        .likert-option.selected { background-color: #e8f4fd; border-color: #3498db; }
        select { padding: 10px; width: 100%; max-width: 300px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 20px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .error-banner { background: #fee; border: 1px solid #fcc; color: #c00; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.85em; color: #666; }
        footer p { margin: 5px 0; }
    </style>
</head>
<body>

<noscript>
    <div class="container" style="margin-top: 20px;">
        <div class="error-banner" style="display:block;">
            <strong>JavaScript is disabled or blocked.</strong><br>
            This questionnaire requires JavaScript to run. Please enable JavaScript for this site, then refresh.<br><br>
            Common causes: site setting “Disable JavaScript”, privacy mode restrictions, enterprise/school policies, or blockers (uBlock/NoScript/Brave Shields/security suites).
        </div>
    </div>
</noscript>

<div id="loading-overlay">
    <h2>Loading Diagnostic Tool...</h2>
    <div id="error-message" class="error-banner hidden"></div>
</div>

<div class="container hidden" id="app-container">
    <div id="app-error" class="error-banner hidden" style="margin-bottom:1em;"></div>
    <!-- Step 1: Landing & Ethics -->
    <div id="step-landing">
        <h1>Industry Diagnostic Questionnaire</h1>
        
        <div class="compliance-box">
            <h3>Ethics & Consent (Strictly Confidential)</h3>
            <ul>
                <li><strong>Participation is voluntary.</strong> You may skip any question. You may withdraw at any time before submission.</li>
                <li><strong>No personal data is required.</strong> Please do not include names, phone numbers, client details, or confidential identifiers.</li>
                <li><strong>No Commercial Use.</strong> Responses will not be used for sales, supplier ranking, marketing, or any commercial decisioning.</li>
                <li><strong>Anonymity Options.</strong> You may respond anonymously. If you provide contact details, they will be used only for research follow-up and will not be shared.</li>
                <li><strong>Data Retention.</strong> Data will be stored securely and accessed only by authorised research personnel. Retention period: 5 years from publication.</li>
            </ul>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ddd;">
                <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="consent-check" style="margin-top: 5px;">
                    <span>I have read the above and consent to participate in this industry research diagnostic.</span>
                </label>
            </div>
        </div>

        <div class="section">
            <label for="role-select" style="display: block; margin-bottom: 10px; font-weight: bold;">Select your primary role:</label>
            <select id="role-select" disabled>
                <option value="">-- Choose Role --</option>
            </select>
        </div>

        <button id="btn-start" class="btn" disabled>Start Diagnostic</button>
    </div>

    <!-- Step 2: Questions -->
    <div id="step-questions" class="hidden">
        <h2 id="role-title">Questionnaire</h2>
        <div id="questions-container"></div>
        
        <div style="margin-top: 30px; display: flex; gap: 15px;">
            <button id="btn-submit" class="btn">Complete & Download Responses</button>
            <button id="btn-withdraw" class="btn" style="background: #e74c3c;">Withdraw</button>
        </div>
    </div>

    <!-- Step 3: Completion -->
    <div id="step-complete" class="hidden">
        <div style="text-align: center; padding: 40px 0;">
            <h2 style="color: #27ae60;">Thank You</h2>
            <p>Your responses have been generated successfully.</p>
            <p style="margin: 20px 0;">Please save the JSON file below and email it to the research administrator.</p>
            
            <a id="download-link" class="btn" style="background: #27ae60;">Download Response JSON</a>
            
            <p style="margin-top: 30px; font-size: 0.9em; color: #7f8c8d;">
                This file contains only your role selection and anonymous item responses.<br>
                No data has been sent to any server.
            </p>
        </div>
    </div>

    <footer>
        <p><strong>Research Lead / Governance Entity:</strong> Jacq Lew, Project Lead (College-led applied research initiative)</p>
        <p><strong>Contact Email:</strong> eghire.contact@gmail.com</p>
        <p>This tool is for non-commercial industry diagnostic research only.</p>
        <p>Participation is voluntary. Data is stored securely.
        <br>Withdrawal after submission: email eghire.contact@gmail.com with timestamp + organisation (optional).</p>
        <p>Data minimization: No personal identifiers collected.</p>
        <p>Retention period: 5 years from publication.</p>
    </footer>
</div>

<script>
(function() {
    // Always-visible boot marker (helps diagnose "stuck on loading")
    console.log("[external] boot", { href: location.href, ts: new Date().toISOString() });

    let config = null;
    let selectedRole = null;
    let responses = {};
    const appState = {
        meta: null
    };

    const els = {
        loading: document.getElementById('loading-overlay'),
        error: document.getElementById('error-message'),
        app: document.getElementById('app-container'),
        landing: document.getElementById('step-landing'),
        questions: document.getElementById('step-questions'),
        complete: document.getElementById('step-complete'),
        roleSelect: document.getElementById('role-select'),
        consentCheck: document.getElementById('consent-check'),
        btnStart: document.getElementById('btn-start'),
        questionsContainer: document.getElementById('questions-container'),
        btnSubmit: document.getElementById('btn-submit'),
        btnWithdraw: document.getElementById('btn-withdraw'),
        downloadLink: document.getElementById('download-link'),
        roleTitle: document.getElementById('role-title'),
        appError: document.getElementById('app-error')
    };

    function hideLoadingShowApp() {
        if (els.loading) els.loading.classList.add('hidden');
        if (els.app) els.app.classList.remove('hidden');
    }

    function showErrorAndRevealApp(msg) {
        showError(msg);
        if (els.appError) { els.appError.textContent = msg; els.appError.classList.remove('hidden'); }
        hideLoadingShowApp();
    }

    // Surface unexpected JS errors instead of silently hanging on loading overlay.
    window.addEventListener('error', (e) => {
        var msg = "Runtime Error: " + (e?.error?.message || e?.message || String(e));
        console.error("[external] window.error", e?.error || e?.message || e);
        showErrorAndRevealApp(msg);
    });
    window.addEventListener('unhandledrejection', (e) => {
        var msg = "Promise Rejection: " + (e?.reason?.message || String(e?.reason || e));
        console.error("[external] unhandledrejection", e?.reason || e);
        showErrorAndRevealApp(msg);
    });

    // Initialization: use absolute URL so path is correct on GitHub Pages (no base/redirect issues).
    var configUrl = new URL('../config/questionnaire.v1.json', location.href).href;
    fetch(configUrl, { cache: 'no-store' })
        .then(r => {
            if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
            return r.json();
        })
        .then(data => {
            console.log("[external] questionnaire loaded", {
                version: data?.meta?.version,
                roles: Array.isArray(data?.roles) ? data.roles.length : null
            });
            config = data;
            validateConfig(config);
            initUI();
        })
        .catch(err => {
            console.error("[external] config fetch/init failed", err);
            showErrorAndRevealApp("Configuration Error: " + err.message);
        });

    function validateConfig(cfg) {
        if (cfg.meta.version !== "v1.0") console.warn("Version mismatch warning");
        if (!cfg.roles || cfg.roles.length === 0) throw new Error("No roles defined in config");
        // Strict academic validation could go here
    }

    function showError(msg) {
        els.error.textContent = msg;
        els.error.classList.remove('hidden');
    }

    function initUI() {
        els.loading.classList.add('hidden');
        els.app.classList.remove('hidden');

        // Populate Roles
        config.roles.forEach(role => {
            const opt = document.createElement('option');
            opt.value = role.id;
            opt.textContent = role.label;
            els.roleSelect.appendChild(opt);
        });

        // Event Listeners
        els.consentCheck.addEventListener('change', updateStartButton);
        els.roleSelect.addEventListener('change', updateStartButton);
        els.btnStart.addEventListener('click', startQuestionnaire);
        els.btnSubmit.addEventListener('click', finishQuestionnaire);
        els.btnWithdraw.addEventListener('click', () => window.location.reload());
    }

    function updateStartButton() {
        const isConsent = els.consentCheck.checked;
        const isRole = els.roleSelect.value !== "";
        els.btnStart.disabled = !(isConsent && isRole);
        els.roleSelect.disabled = !isConsent;
    }

    function startQuestionnaire() {
        selectedRole = els.roleSelect.value;
        const roleData = config.roles.find(r => r.id === selectedRole);
        const questions = config.items_by_role[selectedRole];

        if (!questions || questions.length !== 15) {
            showError(`Configuration Error: Expected 15 questions for role '${selectedRole}', found ${questions ? questions.length : 0}.`);
            return;
        }

        els.roleTitle.textContent = `${roleData.label} Questionnaire`;
        renderQuestions(questions);

        els.landing.classList.add('hidden');
        els.questions.classList.remove('hidden');
        window.scrollTo(0, 0);
    }

    function renderQuestions(items) {
        els.questionsContainer.innerHTML = '';
        items.forEach((item, idx) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'question-item';
            
            const qText = document.createElement('label');
            qText.className = 'question-text';
            qText.textContent = `${idx + 1}. ${item.text}`;
            qDiv.appendChild(qText);

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'likert-options';

            const scaleMap = config.likert_maps[item.scale];
            if (!scaleMap) {
                console.error(`Missing scale map for ${item.scale}`);
                return;
            }

            scaleMap.forEach(opt => {
                const optLabel = document.createElement('label');
                optLabel.className = 'likert-option';
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = item.id;
                input.value = opt.value;
                input.onclick = (e) => {
                    responses[item.id] = parseInt(e.target.value, 10);
                    // Visual feedback
                    optionsContainer.querySelectorAll('.likert-option').forEach(l => l.classList.remove('selected'));
                    optLabel.classList.add('selected');
                };

                optLabel.appendChild(input);
                optLabel.appendChild(document.createTextNode(opt.label));
                optionsContainer.appendChild(optLabel);
            });

            qDiv.appendChild(optionsContainer);
            els.questionsContainer.appendChild(qDiv);
        });
    }

    function finishQuestionnaire() {
        // Prepare Export
        const exportData = {
            meta: {
                questionnaire_version: config.meta.version,
                generated_at: new Date().toISOString()
            },
            role: selectedRole,
            responses: responses,
            notes: "Research-only data. Not for commercial use."
        };

        const jsonStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        els.downloadLink.href = url;
        els.downloadLink.download = `response_${selectedRole}_${Date.now()}.json`;

        els.questions.classList.add('hidden');
        els.complete.classList.remove('hidden');
        window.scrollTo(0, 0);
    }
})();
</script>

</body>
</html>